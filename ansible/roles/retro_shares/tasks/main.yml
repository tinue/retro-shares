---
- name: Check if Docker is installed
  command: docker --version
  register: docker_check
  ignore_errors: yes
  changed_when: false

- name: Fail if Docker is not installed
  fail:
    msg: "Docker is not installed on this server. Please install Docker before running this playbook."
  when: docker_check.rc != 0

- name: Check if Docker Compose is available
  command: docker compose version
  register: compose_check
  ignore_errors: yes
  changed_when: false

- name: Fail if Docker Compose is not available
  fail:
    msg: "Docker Compose is not available. Please install Docker Compose (v2) before running this playbook."
  when: compose_check.rc != 0

- name: Check if Docker service is running
  service:
    name: docker
    state: started
  register: docker_service
  ignore_errors: yes

- name: Fail if Docker service is not running
  fail:
    msg: "Docker service is not running. Please start Docker before running this playbook."
  when: docker_service.failed | default(false)

- name: Install git (if not present)
  package:
    name: git
    state: present

- name: Create docker user
  user:
    name: "{{ docker_user }}"
    shell: /bin/bash
    create_home: yes
    state: present

- name: Add docker user to docker group
  user:
    name: "{{ docker_user }}"
    groups: docker
    append: yes

- name: Create project directory
  file:
    path: "{{ install_path }}"
    state: directory
    mode: '0755'
    owner: "{{ docker_user }}"
    group: "{{ docker_user }}"

- name: Install acl (if not present), required due to the become_user in the next step
  package:
    name: acl
    state: present

- name: Clone or update repository from GitHub
  git:
    repo: "{{ github_repo }}"
    dest: "{{ install_path }}"
    version: "{{ github_branch }}"
    force: yes
    accept_newhostkey: yes
  become_user: "{{ docker_user }}"

- name: Create data directory for shared files
  file:
    path: "{{ install_path }}/data"
    state: directory
    mode: '0775'
    owner: "{{ docker_user }}"
    group: "{{ docker_user }}"

- name: Get docker user UID
  command: "id -u {{ docker_user }}"
  register: docker_user_uid
  changed_when: false

- name: Get docker user GID
  command: "id -g {{ docker_user }}"
  register: docker_user_gid
  changed_when: false

- name: Create .env file with credentials
  copy:
    content: |
      SMB_USER={{ smb_user }}
      SMB_PASSWORD={{ smb_password }}
      SMB_RO_USER={{ smb_ro_user | default('') }}
      SMB_RO_PASSWORD={{ smb_ro_password | default('') }}
      PUID={{ docker_user_uid.stdout }}
      PGID={{ docker_user_gid.stdout }}
    dest: "{{ install_path }}/.env"
    mode: '0600'
    owner: "{{ docker_user }}"
    group: "{{ docker_user }}"

- name: Stop existing containers (if any)
  command: docker compose down
  args:
    chdir: "{{ install_path }}"
  become_user: "{{ docker_user }}"
  ignore_errors: yes
  changed_when: false

- name: Build and start the Retro Shares container
  command: docker compose up -d --build
  args:
    chdir: "{{ install_path }}"
  become_user: "{{ docker_user }}"
  register: compose_up

- name: Wait for container to be healthy
  pause:
    seconds: 5

- name: Verify container is running
  command: docker compose ps
  args:
    chdir: "{{ install_path }}"
  become_user: "{{ docker_user }}"
  register: container_status
  changed_when: false

- name: Display container status
  debug:
    var: container_status.stdout_lines

- name: Display connection information
  debug:
    msg: >-
      {{
        [
          "Retro Shares has been deployed successfully!",
          "NetBIOS Name: RETRO",
          "Share Path: \\RETRO\retro",
          "Anonymous access: read-only",
          "Authenticated user: " ~ smb_user ~ " (read-write)"
        ]
        + (["Authenticated user: " ~ smb_ro_user ~ " (read-only)"] if smb_ro_user | default('') else [])
        + ["Data directory: " ~ install_path ~ "/data"]
      }}
